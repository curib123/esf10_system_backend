generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* ============================
   AUTH & RBAC
============================ */

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  fullName  String
  isActive  Boolean  @default(true)
  deletedAt DateTime?        // ðŸ‘ˆ SOFT DELETE

  roles     UserRole[]
  auditLogs AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Role {
  id          Int    @id @default(autoincrement())
  name        String @unique
  description String?

  users        UserRole[]
  permissions  RolePermission[]
  
  deletedAt DateTime?  
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
}

model Permission {
  id          Int    @id @default(autoincrement())
  code        String @unique
  description String?

  roles RolePermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
}

/* ============================
   PIVOT: USER â†” ROLE
============================ */

model UserRole {
  userId Int
  roleId Int

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([userId, roleId])
  @@index([roleId])
}

/* ============================
   PIVOT: ROLE â†” PERMISSION
============================ */

model RolePermission {
  roleId       Int
  permissionId Int

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([roleId, permissionId])
  @@index([permissionId])
}

/* ============================
   STUDENT CORE
============================ */

model Student {
  id         Int      @id @default(autoincrement())
  lrn        String   @unique
  firstName  String
  middleName String?
  lastName   String
  gender     String
  birthDate  DateTime
  address    String
  deletedAt  DateTime?        // ðŸ‘ˆ SOFT DELETE

  enrollments Enrollment[]
  documents   Document[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lastName, firstName])
}

/* ============================
   SCHOOL YEAR
============================ */

model SchoolYear {
  id        Int     @id @default(autoincrement())
  year      String  @unique
  isActive  Boolean @default(false)

  enrollments Enrollment[]
}

/* ============================
   CURRICULUM & VERSIONING
============================ */

model Curriculum {
  id    Int    @id @default(autoincrement())
  name  String

  versions CurriculumVersion[]
}

model CurriculumVersion {
  id            Int    @id @default(autoincrement())
  curriculumId  Int
  name          String
  effectiveFrom Int
  effectiveTo   Int?

  curriculum Curriculum @relation(fields: [curriculumId], references: [id])
  subjects   Subject[]
  enrollments Enrollment[]
}

/* ============================
   SUBJECTS
============================ */

model Subject {
  id                  Int    @id @default(autoincrement())
  curriculumVersionId Int
  gradeLevel          String
  code                String
  name                String

  curriculumVersion CurriculumVersion @relation(fields: [curriculumVersionId], references: [id])
  grades             Grade[]

  @@unique([curriculumVersionId, gradeLevel, code])
}

/* ============================
   ENROLLMENT
============================ */

model Enrollment {
  id                  Int      @id @default(autoincrement())
  studentId           Int
  schoolYearId        Int
  curriculumVersionId Int
  gradeLevel          String
  section             String?
  status              EnrollmentStatus @default(ACTIVE)
  deletedAt           DateTime?        // ðŸ‘ˆ SOFT DELETE

  student           Student           @relation(fields: [studentId], references: [id])
  schoolYear        SchoolYear        @relation(fields: [schoolYearId], references: [id])
  curriculumVersion CurriculumVersion @relation(fields: [curriculumVersionId], references: [id])
  grades            Grade[]
  documents         Document[]

  createdAt DateTime @default(now())

  @@unique([studentId, schoolYearId])
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  IMPORTED
}

/* ============================
   GRADES
============================ */

model Grade {
  id           Int      @id @default(autoincrement())
  enrollmentId Int
  subjectId    Int
  period       GradingPeriod
  value        Float
  source       GradeSource @default(SYSTEM)

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id])
  subject    Subject    @relation(fields: [subjectId], references: [id])

  @@unique([enrollmentId, subjectId, period])
}

enum GradeSource {
  SYSTEM
  IMPORTED
}

enum GradingPeriod {
  Q1
  Q2
  Q3
  Q4
  FINAL
}

/* ============================
   DOCUMENTS
============================ */

model Document {
  id           Int      @id @default(autoincrement())
  studentId    Int
  enrollmentId Int?
  type         String
  fileUrl      String
  deletedAt    DateTime?        // ðŸ‘ˆ SOFT DELETE

  student     Student     @relation(fields: [studentId], references: [id])
  enrollment  Enrollment? @relation(fields: [enrollmentId], references: [id])

  uploadedAt DateTime @default(now())
}

/* ============================
   SYSTEM SETTINGS
============================ */

model SystemSetting {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String
}

/* ============================
   AUDIT LOG (IMMUTABLE)
============================ */

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  action    String
  entity    String
  entityId  Int?
  oldValue  Json?
  newValue  Json?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}
