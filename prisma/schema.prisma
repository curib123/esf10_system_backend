generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* ============================
   AUTH & RBAC
============================ */

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  fullName  String
  isActive  Boolean  @default(true)
  deletedAt DateTime?

  roles     UserRole[]
  auditLogs AuditLog[]

  advisedSections Section[] @relation("SectionAdviser")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Role {
  id          Int    @id @default(autoincrement())
  name        String @unique
  description String?

  users        UserRole[]
  permissions  RolePermission[]

  deletedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Permission {
  id          Int    @id @default(autoincrement())
  code        String @unique
  description String?

  roles RolePermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/* ============================
   USER ↔ ROLE
============================ */

model UserRole {
  userId Int
  roleId Int

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([userId, roleId])
  @@index([roleId])
}

/* ============================
   ROLE ↔ PERMISSION
============================ */

model RolePermission {
  roleId       Int
  permissionId Int

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([roleId, permissionId])
  @@index([permissionId])
}

/* ============================
   STUDENT CORE
============================ */

model Student {
  id         Int      @id @default(autoincrement())
  lrn        String   @unique
  firstName  String
  middleName String?
  lastName   String
  gender     String
  birthDate  DateTime
  address    String
  deletedAt  DateTime?

  enrollments Enrollment[]
  documents   Document[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lastName, firstName])
}

/* ============================
   SCHOOL YEAR
============================ */

model SchoolYear {
  id       Int     @id @default(autoincrement())
  year     String  @unique
  isActive Boolean @default(false)

  enrollments Enrollment[]
  sections    Section[]
}

/* ============================
   GRADE LEVELS
============================ */

model GradeLevel {
  id       Int     @id @default(autoincrement())
  code     String  @unique
  name     String
  order    Int
  isActive Boolean @default(true)

  subjects    Subject[]
  enrollments Enrollment[]
  sections    Section[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

/* ============================
   SECTIONS
============================ */

model Section {
  id           Int      @id @default(autoincrement())
  name         String           // A, B, Rose
  gradeLevelId Int
  schoolYearId Int
  adviserId    Int?             // ← User.id

  gradeLevel GradeLevel @relation(fields: [gradeLevelId], references: [id])
  schoolYear SchoolYear @relation(fields: [schoolYearId], references: [id])
  adviser    User?      @relation("SectionAdviser", fields: [adviserId], references: [id])

  enrollments Enrollment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gradeLevelId, schoolYearId, name])
  @@index([adviserId])
}

/* ============================
   CURRICULUM & VERSIONING
============================ */

model Curriculum {
  id   Int    @id @default(autoincrement())
  name String

  versions CurriculumVersion[]
}

model CurriculumVersion {
  id            Int    @id @default(autoincrement())
  curriculumId  Int
  name          String
  effectiveFrom Int
  effectiveTo   Int?

  curriculum Curriculum @relation(fields: [curriculumId], references: [id])
  subjects    Subject[]
  enrollments Enrollment[]
}

/* ============================
   SUBJECTS
============================ */

model Subject {
  id                  Int    @id @default(autoincrement())
  curriculumVersionId Int
  gradeLevelId        Int
  code                String
  name                String

  curriculumVersion CurriculumVersion @relation(fields: [curriculumVersionId], references: [id])
  gradeLevel        GradeLevel        @relation(fields: [gradeLevelId], references: [id])

  grades Grade[]

  @@unique([curriculumVersionId, gradeLevelId, code])
  @@index([gradeLevelId])
}

/* ============================
   ENROLLMENT
============================ */

model Enrollment {
  id                  Int      @id @default(autoincrement())
  studentId           Int
  schoolYearId        Int
  curriculumVersionId Int
  gradeLevelId        Int
  sectionId           Int?
  status              EnrollmentStatus @default(ACTIVE)
  deletedAt           DateTime?

  student           Student           @relation(fields: [studentId], references: [id])
  schoolYear        SchoolYear        @relation(fields: [schoolYearId], references: [id])
  curriculumVersion CurriculumVersion @relation(fields: [curriculumVersionId], references: [id])
  gradeLevel        GradeLevel        @relation(fields: [gradeLevelId], references: [id])
  section           Section?          @relation(fields: [sectionId], references: [id])

  grades    Grade[]
  documents Document[]

  createdAt DateTime @default(now())

  @@unique([studentId, schoolYearId])
  @@index([gradeLevelId])
  @@index([sectionId])
}

enum EnrollmentStatus {
  ACTIVE
  COMPLETED
  IMPORTED
}

/* ============================
   GRADES
============================ */

model Grade {
  id           Int      @id @default(autoincrement())
  enrollmentId Int
  subjectId    Int
  period       GradingPeriod
  value        Float
  source       GradeSource @default(SYSTEM)

  enrollment Enrollment @relation(fields: [enrollmentId], references: [id])
  subject    Subject    @relation(fields: [subjectId], references: [id])

  @@unique([enrollmentId, subjectId, period])
}

enum GradeSource {
  SYSTEM
  IMPORTED
}

enum GradingPeriod {
  Q1
  Q2
  Q3
  Q4
  FINAL
}

/* ============================
   DOCUMENTS
============================ */

model Document {
  id           Int      @id @default(autoincrement())
  studentId    Int
  enrollmentId Int?
  type         String
  fileUrl      String
  deletedAt    DateTime?

  student    Student     @relation(fields: [studentId], references: [id])
  enrollment Enrollment? @relation(fields: [enrollmentId], references: [id])

  uploadedAt DateTime @default(now())
}

/* ============================
   SYSTEM SETTINGS
============================ */

model SystemSetting {
  id    Int    @id @default(autoincrement())
  key   String @unique
  value String
}

/* ============================
   AUDIT LOG (IMMUTABLE)
============================ */

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  action    String
  entity    String
  entityId  Int?
  oldValue  Json?
  newValue  Json?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}
